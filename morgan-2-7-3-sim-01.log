------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  /Users/smorgan/Documents/GitHub/Morgan-Winship-2015/morgan-2-7-3-sim-01.log
  log type:  text
 opened on:  22 Jul 2022, 10:41:52

. 
. ********************************************************************************
. ********************************************************************************
. *** Example for Simulation:  Returns to BA attainment (from section 2.7.3)
. ********************************************************************************
. ********************************************************************************
. 
. *** N for simulation (where we start with a large pseudo population)
. 
. set obs 1000000 
Number of observations (_N) was 0, now 1,000,000.

. 
. *** Set seed for reproducibility (Steve's birthday. Don't forget it!)
. 
. set seed 73071

. 
. ********************************************************************************
. *** Set up potential outcomes and treatment selection pattern to match the
. ***   example stipulated in Table 2.3 and its accompanying text.  
. 
. ***   (Note:  This way of setting up the simulation produces the desiered 
. ***           joint distribution, but it departs from the individual-level 
. ***           choice narrative in the text.  The second example below will 
. ***           produce the same pattern of results, and it is based on a setup 
. ***           that explicitly matches the selection narrative from the text.)
. ********************************************************************************
. 
. *** Generate the specified proportion of the pseudo population as BA attainers
. 
. gen ba = rbinomial(1, .3)

. 
. *** Generate potential outcomes as if all individuals could be in each of the 
. ***   four subpopulations in Table 2.3 
. 
. gen y1_chooser = rnormal(10, 2)

. gen y0_chooser = rnormal(6, 2)

. gen y1_non = rnormal(8, 2)

. gen y0_non = rnormal(5, 2)

. 
. *** Use the BA attainment draw to assign the appropriate potential outcomes
. ***   to each individual.  (This should 'feel' backwards.  We are defining
. ***   the potential outcomes, as if we know the treatment that will be
. ***   chosen.  This is, therefore, a mechanical way of getting the stipulated
. ***   joint distribution without having to introduce any other variables that
. ***   encode why some individuals are choosers or not.  It could be that
. ***   "chooser" and "non" above are "smart" and "less smart."  But the setup
. ***   is completely general.)
. 
. gen y1 =  [ba * y1_chooser] + [(1 - ba) * y1_non] /* 10 or 8, on average */ 

. gen y0 =  [ba * y0_chooser] + [(1 - ba) * y0_non] /* 6 or 5, on average */ 

. gen ite = y1 - y0

. 
. *** Generate the observed outcome               
. 
. gen y = [ba * y1] + [(1- ba) * y0] 

. 
. ********************************************************************************
. *** For comparison, create a BA attainment variable and observed outcome 
. ***   variable AS IF we randomly reassigned the same individuals (while
. ***   leaving their potential outcomes the same as above) to BA attainment
. ***   or not
. ********************************************************************************
.                 
. gen ba_rand = rbinomial(1, .3)

. gen y_rand =  [ba_rand * y1] + [(1 - ba_rand) * y0]

. 
. ********************************************************************************
. *** Simulation results
. ********************************************************************************
. 
. *** Summarize the constructed data and treatment effects at the population level 
. 
. summ

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          ba |  1,000,000     .300319    .4583969          0          1
  y1_chooser |  1,000,000    9.998254    1.999235  -.6058416   19.15098
  y0_chooser |  1,000,000    5.996739    2.000523   -4.12368   15.65341
      y1_non |  1,000,000    7.999489    2.000223  -1.137737   17.34856
      y0_non |  1,000,000    5.001458    2.000678  -4.920749   14.18757
-------------+---------------------------------------------------------
          y1 |  1,000,000    8.599779     2.19985  -1.137737   19.04937
          y0 |  1,000,000    5.300552    2.051836  -4.920749   15.58629
         ite |  1,000,000    3.299227    2.867003  -9.866383    16.6433
           y |  1,000,000     6.50224    3.040578  -4.920749   19.04937
     ba_rand |  1,000,000     .300216     .458352          0          1
-------------+---------------------------------------------------------
      y_rand |  1,000,000    6.291156    2.587603  -4.920749    18.2649

. mean y0 y1 ite y, over(ba)

Mean estimation                      Number of obs = 1,000,000

--------------------------------------------------------------
             |       Mean   Std. err.     [95% conf. interval]
-------------+------------------------------------------------
     c.y0@ba |
          0  |       5.00       0.00          5.00        5.01
          1  |       6.00       0.00          5.99        6.00
             |
     c.y1@ba |
          0  |       8.00       0.00          8.00        8.00
          1  |      10.00       0.00          9.99       10.00
             |
    c.ite@ba |
          0  |       3.00       0.00          2.99        3.00
          1  |       4.00       0.01          3.99        4.01
             |
      c.y@ba |
          0  |       5.00       0.00          5.00        5.01
          1  |      10.00       0.00          9.99       10.00
--------------------------------------------------------------

. regress y ba

      Source |       SS           df       MS      Number of obs   = 1,000,000
-------------+----------------------------------   F(1, 999998)    >  99999.00
       Model |  5242740.79         1  5242740.79   Prob > F        =    0.0000
    Residual |   4002364.4   999,998  4.00237241   R-squared       =    0.5671
-------------+----------------------------------   Adj R-squared   =    0.5671
       Total |  9245105.19   999,999  9.24511443   Root MSE        =    2.0006

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          ba |       5.00       0.00  1144.51    0.00         4.99        5.00
       _cons |       5.00       0.00  2091.45    0.00         5.00        5.01
------------------------------------------------------------------------------

. mean y0 y1 ite y_rand, over(ba_rand)

Mean estimation                          Number of obs = 1,000,000

------------------------------------------------------------------
                 |       Mean   Std. err.     [95% conf. interval]
-----------------+------------------------------------------------
    c.y0@ba_rand |
              0  |       5.30       0.00          5.30        5.31
              1  |       5.30       0.00          5.29        5.31
                 |
    c.y1@ba_rand |
              0  |       8.60       0.00          8.59        8.60
              1  |       8.60       0.00          8.59        8.61
                 |
   c.ite@ba_rand |
              0  |       3.30       0.00          3.29        3.31
              1  |       3.30       0.01          3.29        3.31
                 |
c.y_rand@ba_rand |
              0  |       5.30       0.00          5.30        5.31
              1  |       8.60       0.00          8.59        8.61
------------------------------------------------------------------

. regress y_rand ba_rand

      Source |       SS           df       MS      Number of obs   = 1,000,000
-------------+----------------------------------   F(1, 999998)    >  99999.00
       Model |  2287463.71         1  2287463.71   Prob > F        =    0.0000
    Residual |  4408217.82   999,998  4.40822664   R-squared       =    0.3416
-------------+----------------------------------   Adj R-squared   =    0.3416
       Total |  6695681.53   999,999  6.69568823   Root MSE        =    2.0996

------------------------------------------------------------------------------
      y_rand | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     ba_rand |       3.30       0.00   720.35    0.00         3.29        3.31
       _cons |       5.30       0.00  2111.88    0.00         5.30        5.31
------------------------------------------------------------------------------

. 
. *** Sample and estimate
. 
. sample 2500, count
(997,500 observations deleted)

. summ

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          ba |      2,500       .3032    .4597329          0          1
  y1_chooser |      2,500    9.962611     1.99943   3.415494   17.96594
  y0_chooser |      2,500    5.935218    1.962044   -1.41397    13.5398
      y1_non |      2,500    7.969973    1.988248   .7604777    16.1692
      y0_non |      2,500    5.021986    1.992848  -2.763323   11.77171
-------------+---------------------------------------------------------
          y1 |      2,500    8.582524    2.202653   .7604777   16.18705
          y0 |      2,500    5.332688    2.028932  -2.763323   12.63987
         ite |      2,500    3.249837    2.863899  -5.569639   13.18309
           y |      2,500    6.563276    3.051728  -2.763323   16.18705
     ba_rand |      2,500        .308    .4617589          0          1
-------------+---------------------------------------------------------
      y_rand |      2,500    6.330093    2.542324  -2.688844   15.89122

. mean y0 y1 ite y, over(ba)

Mean estimation                          Number of obs = 2,500

--------------------------------------------------------------
             |       Mean   Std. err.     [95% conf. interval]
-------------+------------------------------------------------
     c.y0@ba |
          0  |       5.05       0.05          4.95        5.14
          1  |       5.98       0.07          5.85        6.12
             |
     c.y1@ba |
          0  |       7.95       0.05          7.85        8.04
          1  |      10.04       0.07          9.90       10.19
             |
    c.ite@ba |
          0  |       2.90       0.07          2.76        3.03
          1  |       4.06       0.10          3.86        4.26
             |
      c.y@ba |
          0  |       5.05       0.05          4.95        5.14
          1  |      10.04       0.07          9.90       10.19
--------------------------------------------------------------

. regress y ba

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(1, 2498)      =   3260.00
       Model |  13176.6242         1  13176.6242   Prob > F        =    0.0000
    Residual |  10096.6753     2,498  4.04190365   R-squared       =    0.5662
-------------+----------------------------------   Adj R-squared   =    0.5660
       Total |  23273.2995     2,499  9.31304504   Root MSE        =    2.0104

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          ba |       4.99       0.09    57.10    0.00         4.82        5.17
       _cons |       5.05       0.05   104.82    0.00         4.95        5.14
------------------------------------------------------------------------------

. mean y0 y1 ite y_rand, over(ba_rand)

Mean estimation                              Number of obs = 2,500

------------------------------------------------------------------
                 |       Mean   Std. err.     [95% conf. interval]
-----------------+------------------------------------------------
    c.y0@ba_rand |
              0  |       5.35       0.05          5.25        5.44
              1  |       5.30       0.07          5.15        5.45
                 |
    c.y1@ba_rand |
              0  |       8.60       0.05          8.50        8.71
              1  |       8.54       0.08          8.38        8.69
                 |
   c.ite@ba_rand |
              0  |       3.25       0.07          3.12        3.39
              1  |       3.24       0.10          3.03        3.44
                 |
c.y_rand@ba_rand |
              0  |       5.35       0.05          5.25        5.44
              1  |       8.54       0.08          8.38        8.69
------------------------------------------------------------------

. regress y_rand ba_rand

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(1, 2498)      =   1262.47
       Model |  5422.58407         1  5422.58407   Prob > F        =    0.0000
    Residual |  10729.4839     2,498  4.29522975   R-squared       =    0.3357
-------------+----------------------------------   Adj R-squared   =    0.3355
       Total |   16152.068     2,499  6.46341256   Root MSE        =    2.0725

------------------------------------------------------------------------------
      y_rand | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     ba_rand |       3.19       0.09    35.53    0.00         3.01        3.37
       _cons |       5.35       0.05   107.32    0.00         5.25        5.45
------------------------------------------------------------------------------

. 
. ********************************************************************************
. ********************************************************************************
. *** Alternative: Show the same basic pattern without using subpopulations,
. ***   thereby allowing bias to emerge based on individual-level self-selection
. ********************************************************************************
. ********************************************************************************
. 
. capture clear

. 
. *** N for simulation (where we start with a large pseudo population)
. 
. set obs 1000000 
Number of observations (_N) was 0, now 1,000,000.

. 
. *** Set seed for reproducibility (Steve's birthday. Don't forget it!)
. 
. set seed 73071

. 
. *** Generate data from a self-selection model, where the potential outcome 
. ***   y1 is y0 with an ite added to it (and where the ite has both a random
. ***   component and a component correlated with y0).  As a result, selection on 
. ***   the ite, with noise, is selection both on the level of y0 and the
. ***   purely individual determinant of the ite.  This generates the two sources
. ***   of bias outlined in the text.
. 
. gen y0 = rnormal(100, 10)

. gen ite = [y0 * rnormal(0.05, 0.001)] + rnormal(5, 1)

. gen y1 = y0 + ite

. gen ba = [ite + rnormal(0, 1) > 10.75] 

. 
. summ

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          y0 |  1,000,000    99.98396    9.999963   46.97079   145.7549
         ite |  1,000,000    9.998893    1.122082   4.709392   15.37473
          y1 |  1,000,000    109.9829    10.54796   54.00191   158.3289
          ba |  1,000,000     .308148    .4617283          0          1

. corr
(obs=1,000,000)

             |       y0      ite       y1       ba
-------------+------------------------------------
          y0 |   1.0000
         ite |   0.4456   1.0000
          y1 |   0.9955   0.5289   1.0000
          ba |   0.2539   0.5692   0.3013   1.0000


. 
. gen y = [ba * y1] + [(1 - ba)* y0]

. 
. *** outcome and treatment from an ex post randomization of ba completion                
. 
. gen ba_rand = rbinomial(1, .5)

. gen y_rand =  [ba_rand * y1] + [(1 - ba_rand) * y0]

. 
. ********************************************************************************
. *** Simulation results
. ********************************************************************************
. 
. *** Summarize the constructed data and treatment effects at the population level 
. 
. summ

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          y0 |  1,000,000    99.98396    9.999963   46.97079   145.7549
         ite |  1,000,000    9.998893    1.122082   4.709392   15.37473
          y1 |  1,000,000    109.9829    10.54796   54.00191   158.3289
          ba |  1,000,000     .308148    .4617283          0          1
           y |  1,000,000      103.36    12.38271   46.97079   158.3289
-------------+---------------------------------------------------------
     ba_rand |  1,000,000     .500002    .5000002          0          1
      y_rand |  1,000,000    104.9834    11.42895    49.6379   158.3289

. mean y0 y1 ite y, over(ba)

Mean estimation                      Number of obs = 1,000,000

--------------------------------------------------------------
             |       Mean   Std. err.     [95% conf. interval]
-------------+------------------------------------------------
     c.y0@ba |
          0  |      98.29       0.01         98.27       98.31
          1  |     103.79       0.02        103.76      103.82
             |
     c.y1@ba |
          0  |     107.86       0.01        107.84      107.89
          1  |     114.74       0.02        114.71      114.78
             |
    c.ite@ba |
          0  |       9.57       0.00          9.57        9.57
          1  |      10.96       0.00         10.95       10.96
             |
      c.y@ba |
          0  |      98.29       0.01         98.27       98.31
          1  |     114.74       0.02        114.71      114.78
--------------------------------------------------------------

. regress y ba

      Source |       SS           df       MS      Number of obs   = 1,000,000
-------------+----------------------------------   F(1, 999998)    >  99999.00
       Model |    57730258         1    57730258   Prob > F        =    0.0000
    Residual |  95601182.5   999,998  95.6013737   R-squared       =    0.3765
-------------+----------------------------------   Adj R-squared   =    0.3765
       Total |   153331441   999,999  153.331594   Root MSE        =    9.7776

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          ba |      16.46       0.02   777.09    0.00        16.41       16.50
       _cons |      98.29       0.01  8361.43    0.00        98.27       98.31
------------------------------------------------------------------------------

. mean y0 y1 ite y_rand, over(ba_rand)

Mean estimation                          Number of obs = 1,000,000

------------------------------------------------------------------
                 |       Mean   Std. err.     [95% conf. interval]
-----------------+------------------------------------------------
    c.y0@ba_rand |
              0  |      99.98       0.01         99.96      100.01
              1  |      99.98       0.01         99.96      100.01
                 |
    c.y1@ba_rand |
              0  |     109.98       0.01        109.95      110.01
              1  |     109.98       0.01        109.95      110.01
                 |
   c.ite@ba_rand |
              0  |      10.00       0.00         10.00       10.00
              1  |      10.00       0.00         10.00       10.00
                 |
c.y_rand@ba_rand |
              0  |      99.98       0.01         99.96      100.01
              1  |     109.98       0.01        109.95      110.01
------------------------------------------------------------------

. regress y_rand ba_rand

      Source |       SS           df       MS      Number of obs   = 1,000,000
-------------+----------------------------------   F(1, 999998)    >  99999.00
       Model |    24992300         1    24992300   Prob > F        =    0.0000
    Residual |   105628492   999,998  105.628703   R-squared       =    0.1913
-------------+----------------------------------   Adj R-squared   =    0.1913
       Total |   130620792   999,999  130.620922   Root MSE        =    10.278

------------------------------------------------------------------------------
      y_rand | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     ba_rand |      10.00       0.02   486.42    0.00         9.96       10.04
       _cons |      99.98       0.01  6878.98    0.00        99.96      100.01
------------------------------------------------------------------------------

. 
. *** Sample and estimate
. 
. sample 2500, count
(997,500 observations deleted)

. summ

    Variable |        Obs        Mean    Std. dev.       Min        Max
-------------+---------------------------------------------------------
          y0 |      2,500    99.67499    9.765438   66.65522   141.8996
         ite |      2,500    9.971687    1.108771   6.496271   14.16908
          y1 |      2,500    109.6467    10.28456   75.26226   155.5888
          ba |      2,500       .3108    .4629137          0          1
           y |      2,500    103.0713    12.15655   66.65522   155.5888
-------------+---------------------------------------------------------
     ba_rand |      2,500       .4996    .5000999          0          1
      y_rand |      2,500     104.666    11.25836   66.65522   141.8996

. mean y0 y1 ite y, over(ba)

Mean estimation                          Number of obs = 2,500

--------------------------------------------------------------
             |       Mean   Std. err.     [95% conf. interval]
-------------+------------------------------------------------
     c.y0@ba |
          0  |      98.04       0.23         97.59       98.48
          1  |     103.31       0.35        102.63      103.99
             |
     c.y1@ba |
          0  |     107.58       0.23        107.12      108.04
          1  |     114.24       0.36        113.53      114.94
             |
    c.ite@ba |
          0  |       9.54       0.02          9.50        9.58
          1  |      10.93       0.03         10.86       10.99
             |
      c.y@ba |
          0  |      98.04       0.23         97.59       98.48
          1  |     114.24       0.36        113.53      114.94
--------------------------------------------------------------

. regress y ba

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(1, 2498)      =   1534.57
       Model |  140537.269         1  140537.269   Prob > F        =    0.0000
    Residual |  228768.965     2,498  91.5808505   R-squared       =    0.3805
-------------+----------------------------------   Adj R-squared   =    0.3803
       Total |  369306.233     2,499  147.781606   Root MSE        =    9.5698

------------------------------------------------------------------------------
           y | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
          ba |      16.20       0.41    39.17    0.00        15.39       17.01
       _cons |      98.04       0.23   425.23    0.00        97.58       98.49
------------------------------------------------------------------------------

. mean y0 y1 ite y_rand, over(ba_rand)

Mean estimation                              Number of obs = 2,500

------------------------------------------------------------------
                 |       Mean   Std. err.     [95% conf. interval]
-----------------+------------------------------------------------
    c.y0@ba_rand |
              0  |      99.52       0.28         98.97      100.07
              1  |      99.83       0.27         99.30      100.36
                 |
    c.y1@ba_rand |
              0  |     109.47       0.30        108.89      110.05
              1  |     109.82       0.29        109.26      110.38
                 |
   c.ite@ba_rand |
              0  |       9.95       0.03          9.89       10.01
              1  |       9.99       0.03          9.93       10.05
                 |
c.y_rand@ba_rand |
              0  |      99.52       0.28         98.97      100.07
              1  |     109.82       0.29        109.26      110.38
------------------------------------------------------------------

. regress y_rand ba_rand

      Source |       SS           df       MS      Number of obs   =     2,500
-------------+----------------------------------   F(1, 2498)      =    661.43
       Model |  66311.5425         1  66311.5425   Prob > F        =    0.0000
    Residual |  250438.182     2,498  100.255477   R-squared       =    0.2093
-------------+----------------------------------   Adj R-squared   =    0.2090
       Total |  316749.724     2,499   126.75059   Root MSE        =    10.013

------------------------------------------------------------------------------
      y_rand | Coefficient  Std. err.      t    P>|t|     [95% conf. interval]
-------------+----------------------------------------------------------------
     ba_rand |      10.30       0.40    25.72    0.00         9.52       11.09
       _cons |      99.52       0.28   351.55    0.00        98.96      100.08
------------------------------------------------------------------------------

. 
. log close
      name:  <unnamed>
       log:  /Users/smorgan/Documents/GitHub/Morgan-Winship-2015/morgan-2-7-3-sim-01.log
  log type:  text
 closed on:  22 Jul 2022, 10:42:02
------------------------------------------------------------------------------------------------------------------------
